name: CD Pipeline

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [master]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/master'
    environment:
      name: staging
      url: https://staging.yourdomain.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Deploy to staging server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_PORT || 22 }}
        script: |
          # æ‹‰å–æœ€æ–°ä»£ç 
          cd /opt/forge
          git pull origin master

          # æ‹‰å–æœ€æ–°é•œåƒ
          docker compose -f docker-compose.yml pull

          # é‡å¯æœåŠ¡
          docker compose -f docker-compose.yml up -d

          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://yourdomain.com
    needs: []

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract tag version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Build and push release image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stable
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: ${{ secrets.PROD_PORT || 22 }}
        script: |
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          cd /opt/forge
          docker tag forge-app:latest forge-app:backup-$(date +%Y%m%d-%H%M%S)

          # æ›´æ–°ä»£ç åˆ°æŒ‡å®šç‰ˆæœ¬
          git fetch --all --tags
          git checkout ${{ steps.version.outputs.VERSION }}

          # æ›´æ–°é•œåƒæ ‡ç­¾
          sed -i 's|image: forge-app:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}|g' docker-compose.prod.yml

          # æ‹‰å–æ–°é•œåƒ
          docker compose -f docker-compose.prod.yml pull

          # æ»šåŠ¨æ›´æ–°
          docker compose -f docker-compose.prod.yml up -d --no-deps app

          # å¥åº·æ£€æŸ¥
          sleep 30
          if ! curl -f http://localhost:8080/health; then
            echo "Health check failed, rolling back..."
            docker compose -f docker-compose.prod.yml up -d forge-app:backup-$(date +%Y%m%d-%H%M%S)
            exit 1
          fi

          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## ğŸš€ Release ${{ steps.version.outputs.VERSION }}

          ### Changes
          - Auto-generated release from tag ${{ steps.version.outputs.VERSION }}

          ### Docker Image
          ```bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          ```

          ### Deployment
          This release has been automatically deployed to production.
        draft: false
        prerelease: false

  # é€šçŸ¥éƒ¨ç½²ç»“æœ
  notify:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
    - name: Notify on success
      if: needs.deploy-production.result == 'success'
      run: |
        echo "âœ… Production deployment successful!"
        # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€é‚®ä»¶ã€Slackæ¶ˆæ¯ç­‰

    - name: Notify on failure
      if: needs.deploy-production.result == 'failure'
      run: |
        echo "âŒ Production deployment failed!"
        # è¿™é‡Œå¯ä»¥æ·»åŠ é”™è¯¯é€šçŸ¥é€»è¾‘